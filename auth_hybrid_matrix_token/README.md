# Hybrid Matrix Token

This module is an authentication provider for `Prosody` which supports `Matrix`
and standard `Jitsi` token at the same time. The module senses the type of the
token and handles it depending on its type.

## Installation

- Copy the module into the Prosody plugins folder. It's the following folder on
  Debian:

  ```bash
  cd /usr/share/jitsi-meet/prosody-plugins/
  wget -O mod_auth_hybrid_matrix_token.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/auth_hybrid_matrix_token/mod_auth_hybrid_matrix_token.lua
  ```

- Enable module in your prosody config.

  _/etc/prosody/conf.d/meet.mydomain.com.cfg.lua_

  ```lua
  VirtualHost "meet.mydomain.com"
    authentication = "hybrid_matrix_token"

    -- Application ID for standard Jitsi token
    app_id="myappid"
    -- Application secret for standard Jitsi token
    app_secret="myappsecret"

    -- Base URL to the matrix user verification service (without ending slash).
    uvs_base_url = "https://uvs.example.com"

    -- (optional) Must match what is being set as `iss` in tokens generated by
    -- Element's Jitsi widget. It allows all issuers by default.
    -- uvs_issuer = "myissuer"

    -- (optional) UVS auth token, if authentication enabled on UVS.
    -- Uncomment and set the right token if necessary.
    --uvs_auth_token = "changeme"

    -- (optional) Disable room membership verification. When set to true, the 
    -- module will only check whether the user exists on the Matrix server, 
    -- without verifying their membership in the room. This is useful if you 
    -- donâ€™t want to generate a Synapse token for the UVS, as it becomes 
    -- unnecessary in this case. Defaults to false.
    -- uvs_disable_membership_verification = true
    }
  ```

- Affiliation (power level)

  Use `matrix_affiliation` to synchronise Jitsi affiliation according to Matrix
  power level:

  ```bash
  cd /usr/share/jitsi-meet/prosody-plugins/
  wget -O mod_matrix_affiliation.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/auth_hybrid_matrix_token/mod_matrix_affiliation.lua
  ```

  _/etc/prosody/conf.d/meet.mydomain.com.cfg.lua_

  ```lua
  Component "conference.meet.mydomain.com" "muc"
      modules_enabled = {
          "matrix_affiliation";
      }
  ```

- Lobby bypass

  Use `matrix_lobby_bypass` to disable Jitsi lobby check for Matrix's room
  members:

  ```bash
  cd /usr/share/jitsi-meet/prosody-plugins/
  wget -O mod_matrix_lobby_bypass.lua https://raw.githubusercontent.com/jitsi-contrib/prosody-plugins/main/auth_hybrid_matrix_token/mod_matrix_lobby_bypass.lua
  ```

  _/etc/prosody/conf.d/meet.mydomain.com.cfg.lua_

  ```lua
  Component "conference.meet.mydomain.com" "muc"
      modules_enabled = {
          "matrix_lobby_bypass";
      }
  ```

- Restart the services

  ```bash
  systemctl restart prosody.service
  ```

## Similar projects

- [Prosody Auth Matrix User Verification](https://github.com/matrix-org/prosody-mod-auth-matrix-user-verification)

## Sponsors

[![Nordeck](/images/nordeck.png)](https://nordeck.net/)
